generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  accounts    Account[]
  memberships Membership[]
  sessions    Session[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Membership {
  id        String         @id @default(cuid())
  userId    String
  orgId     String
  role      MembershipRole @default(staff)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  org       Org            @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([userId])
  @@index([orgId])
}

model OrgSettings {
  id                      String                 @id @default(cuid())
  orgId                   String                 @unique
  sandboxStatus           SandboxStatus          @default(sandbox_required)
  sensitiveModulesStatus  SensitiveModulesStatus @default(disabled)
  stripeCustomerId        String?                @unique
  stripeSubscriptionId    String?                @unique
  billingStatus           BillingStatus          @default(inactive)
  setupFeePaidAt          DateTime?
  currentPeriodEnd        DateTime?
  smsEnabled              Boolean                @default(false)
  whatsappEnabled         Boolean                @default(false)
  messagingLocale         String                 @default("en-AU")
  defaultInboundReplyText String?
  deniedReplyText         String?
  handoffReplyText        String?
  handoffPhone            String?
  handoffEmail            String?
  handoffSmsTo            String?
  voiceEnabled            Boolean                @default(false)
  callQueueEnabled        Boolean                @default(true)
  callWelcomeText         String?
  callQueueWaitText       String?
  callDenyText            String?
  callHandoffNumber       String?
  recordCalls             Boolean                @default(false)
  faqText                 String?
  aiModelOverride         String?
  bookingConfig           Json?
  takeawayConfig          Json?
  takeawayPaymentConfig   Json?
  monthlyAiBudgetUsd      Float?                 @default(50)
  monthlyTwilioBudgetUsd  Float?                 @default(30)
  hardBudgetLimit         Boolean                @default(true)
  maxEngineRunsPerMinute  Int?                   @default(60)
  maxMessagesPerMinute    Int?                   @default(30)
  aiDisabled              Boolean                @default(false)
  smsDisabled             Boolean                @default(false)
  voiceDisabled           Boolean                @default(false)
  bookingDisabled         Boolean                @default(false)
  takeawayDisabled        Boolean                @default(false)
  paymentDisabled         Boolean                @default(false)
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  callLogs                CallLog[]
  channelEndpoints        ChannelEndpoint[]
  messageLogs             MessageLog[]
  monthlyCosts            MonthlyOrgCost[]
  org                     Org                    @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model MonthlyOrgCost {
  id             String      @id @default(cuid())
  orgId          String
  month          String
  aiCostUsd      Float       @default(0)
  twilioCostUsd  Float       @default(0)
  stripeFeesUsd  Float       @default(0)
  totalCostUsd   Float       @default(0)
  aiTokensInput  Int         @default(0)
  aiTokensOutput Int         @default(0)
  smsCount       Int         @default(0)
  voiceMinutes   Float       @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  orgSettings    OrgSettings @relation(fields: [orgId], references: [orgId], onDelete: Cascade)

  @@unique([orgId, month])
  @@index([month])
}

model ChannelEndpoint {
  id                String           @id @default(cuid())
  orgId             String
  channel           MessagingChannel
  twilioPhoneNumber String
  friendlyName      String?
  isActive          Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  callLogs          CallLog[]
  orgSettings       OrgSettings      @relation(fields: [orgId], references: [orgId], onDelete: Cascade)
  messageLogs       MessageLog[]

  @@unique([channel, twilioPhoneNumber])
  @@index([orgId, channel])
  @@index([twilioPhoneNumber])
}

model MessageLog {
  id               String           @id @default(cuid())
  orgId            String
  endpointId       String?
  channel          MessagingChannel
  direction        MessageDirection
  twilioMessageSid String?          @unique
  from             String
  to               String
  body             String
  status           String?
  errorCode        String?
  errorMessage     String?
  raw              Json             @default("{}")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  channelEndpoint  ChannelEndpoint? @relation(fields: [endpointId], references: [id])
  orgSettings      OrgSettings      @relation(fields: [orgId], references: [orgId], onDelete: Cascade)

  @@index([orgId])
  @@index([channel])
  @@index([direction])
  @@index([twilioMessageSid])
  @@index([createdAt])
  @@index([orgId, createdAt])
  @@index([orgId, direction, createdAt])
}

model CallLog {
  id              String           @id @default(cuid())
  orgId           String?
  endpointId      String?
  twilioCallSid   String           @unique
  from            String
  to              String
  direction       CallDirection    @default(inbound)
  status          String?
  blockedBy       String?
  denyReason      String?
  startedAt       DateTime         @default(now())
  endedAt         DateTime?
  durationSeconds Int?
  recordingUrl    String?
  raw             Json             @default("{}")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  channelEndpoint ChannelEndpoint? @relation(fields: [endpointId], references: [id])
  orgSettings     OrgSettings?     @relation(fields: [orgId], references: [orgId], onDelete: Cascade)

  @@index([orgId])
  @@index([twilioCallSid])
  @@index([status])
  @@index([startedAt])
  @@index([createdAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  orgId       String?
  actorUserId String
  action      String
  details     Json     @default("{}")
  createdAt   DateTime @default(now())

  @@index([orgId])
  @@index([actorUserId])
  @@index([action])
  @@index([createdAt])
}

model StripeEvent {
  id            String    @id @default(cuid())
  stripeEventId String    @unique
  type          String
  orgId         String?
  processed     Boolean   @default(false)
  processedAt   DateTime?
  raw           Json      @default("{}")
  createdAt     DateTime  @default(now())

  @@index([stripeEventId])
  @@index([orgId])
  @@index([type])
  @@index([createdAt])
}

model OrgOnboardingStep {
  id        String               @id @default(cuid())
  orgId     String
  stepKey   String
  status    OnboardingStepStatus @default(todo)
  metadata  Json                 @default("{}")
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@unique([orgId, stepKey])
  @@index([orgId])
  @@index([stepKey])
}

model Org {
  id               String            @id @default(cuid())
  name             String
  industry         String
  timezone         String            @default("Australia/Sydney")
  industryConfigId String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  assignments      AgentAssignment[]
  memberships      Membership[]
  Order            Order[]
  industryConfig   IndustryConfig?   @relation(fields: [industryConfigId], references: [id])
  settings         OrgSettings?

  @@index([industry])
  @@index([industryConfigId])
}

model IndustryConfig {
  id                     String   @id @default(cuid())
  slug                   String   @unique
  title                  String
  rulesJson              Json     @default("{}")
  defaultTemplateSlug    String?
  defaultTemplateVersion String?
  onboardingSteps        Json     @default("[]")
  modules                Json     @default("{\"sms\": true, \"voice\": false, \"payment\": true, \"whatsapp\": true}")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  orgs                   Org[]

  @@index([slug])
}

model AgentTemplate {
  id              String            @id @default(cuid())
  slug            String
  version         String
  title           String
  systemPrompt    String
  intentsAllowed  Json              @default("[]")
  modulesDefault  Json              @default("[]")
  handoffTriggers Json              @default("[]")
  settingsSchema  Json              @default("{}")
  definition      Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  assignments     AgentAssignment[]

  @@unique([slug, version])
  @@index([slug])
}

model AgentAssignment {
  id              String           @id @default(cuid())
  orgId           String
  templateId      String
  templateVersion String
  status          AssignmentStatus @default(pending)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  org             Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  template        AgentTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([templateId])
  @@index([status])
}

model ConversationSession {
  id                String                    @id @default(cuid())
  orgId             String
  channel           MessagingChannel
  contactKey        String
  externalThreadKey String?
  status            ConversationSessionStatus @default(active)
  lastActiveAt      DateTime                  @default(now())
  metadata          Json                      @default("{}")
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  turns             ConversationTurn[]
  engineRuns        EngineRun[]

  @@unique([orgId, channel, contactKey])
  @@index([orgId])
  @@index([channel])
  @@index([contactKey])
  @@index([status])
  @@index([lastActiveAt])
}

model ConversationTurn {
  id        String               @id @default(cuid())
  sessionId String
  role      ConversationTurnRole
  channel   MessagingChannel
  text      String
  raw       Json                 @default("{}")
  createdAt DateTime             @default(now())
  session   ConversationSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([sessionId])
  @@index([role])
}

model EngineRun {
  id               String              @id @default(cuid())
  orgId            String?
  sessionId        String
  agentTemplateId  String?
  industryConfigId String?
  modelUsed        String
  inputTokens      Int?
  outputTokens     Int?
  costUsd          Float?
  decision         Json                @default("{}")
  status           EngineRunStatus     @default(success)
  blockedBy        String?
  errorMessage     String?
  durationMs       Int?
  createdAt        DateTime            @default(now())
  session          ConversationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([sessionId])
  @@index([status])
  @@index([createdAt])
  @@index([agentTemplateId])
  @@index([orgId, createdAt])
}

model OrgIntegration {
  id                    String              @id @default(cuid())
  orgId                 String
  provider              IntegrationProvider
  status                IntegrationStatus   @default(disconnected)
  accessTokenEncrypted  String?
  refreshTokenEncrypted String?
  tokenExpiry           DateTime?
  scope                 String?
  metadata              Json                @default("{}")
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([orgId, provider])
  @@index([orgId])
  @@index([provider])
  @@index([status])
}

model BookingRequestLog {
  id             String               @id @default(cuid())
  orgId          String
  sessionId      String?
  action         BookingAction
  idempotencyKey String?              @unique
  eventId        String?
  input          Json                 @default("{}")
  result         Json                 @default("{}")
  status         BookingRequestStatus
  reason         String?
  createdAt      DateTime             @default(now())

  @@index([orgId])
  @@index([sessionId])
  @@index([action])
  @@index([status])
  @@index([createdAt])
  @@index([idempotencyKey])
}

model Order {
  id                  String             @id @default(cuid())
  orgId               String
  sessionId           String?
  channel             String
  status              OrderStatus        @default(draft)
  customerName        String?
  customerPhone       String
  customerEmail       String?
  pickupTime          DateTime?
  pickupMode          String?
  notes               String?
  totalItems          Int                @default(0)
  summaryText         String
  idempotencyKey      String             @unique
  paymentRequired     Boolean            @default(true)
  paymentStatus       OrderPaymentStatus @default(pending)
  paymentAmountCents  Int?
  paymentCurrency     String             @default("AUD")
  paymentDueAt        DateTime?
  paymentPaidAt       DateTime?
  paymentReceiptEmail String?
  paymentAttemptCount Int                @default(0)
  lastPaymentError    String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  confirmedAt         DateTime?
  expiredAt           DateTime?
  Org                 Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  eventLogs           OrderEventLog[]
  items               OrderItem[]
  paymentLinks        OrderPaymentLink[]

  @@index([orgId])
  @@index([sessionId])
  @@index([status])
  @@index([customerPhone])
  @@index([createdAt])
  @@index([idempotencyKey])
  @@index([paymentStatus])
  @@index([paymentDueAt])
}

model OrderPaymentLink {
  id                      String                 @id @default(cuid())
  orderId                 String
  stripeCheckoutSessionId String                 @unique
  stripePaymentIntentId   String?                @unique
  url                     String
  status                  OrderPaymentLinkStatus @default(active)
  expiresAt               DateTime
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  order                   Order                  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([expiresAt])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  name      String
  quantity  Int      @default(1)
  options   Json?
  notes     String?
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model OrderEventLog {
  id        String         @id @default(cuid())
  orderId   String
  type      OrderEventType
  details   Json           @default("{}")
  createdAt DateTime       @default(now())
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([type])
  @@index([createdAt])
}

enum MembershipRole {
  owner
  manager
  staff
}

enum SandboxStatus {
  sandbox_required
  sandbox_in_progress
  ready_for_review
  approved
  revoked
}

enum SensitiveModulesStatus {
  disabled
  pending_review
  enabled
}

enum OnboardingStepStatus {
  todo
  in_progress
  done
  blocked
}

enum BillingStatus {
  inactive
  incomplete
  active
  past_due
  canceled
}

enum MessagingChannel {
  sms
  whatsapp
  voice
}

enum MessageDirection {
  inbound
  outbound
}

enum CallDirection {
  inbound
  outbound
}

enum AssignmentStatus {
  pending
  active
  rolled_back
}

enum ConversationSessionStatus {
  active
  closed
}

enum ConversationTurnRole {
  user
  assistant
  system
  tool
}

enum EngineRunStatus {
  success
  handoff
  blocked
  error
}

enum IntegrationProvider {
  google
}

enum IntegrationStatus {
  connected
  disconnected
  error
}

enum BookingAction {
  check
  create
  modify
  cancel
}

enum BookingRequestStatus {
  success
  blocked
  error
  handoff
}

enum OrderStatus {
  draft
  pending_confirmation
  pending_payment
  confirmed
  expired
  canceled
}

enum OrderPaymentStatus {
  not_required
  pending
  paid
  failed
  expired
  canceled
}

enum OrderPaymentLinkStatus {
  active
  completed
  expired
  canceled
}

enum OrderEventType {
  draft_created
  draft_updated
  confirmation_requested
  confirmed
  expired
  canceled
  handoff_triggered
  notification_sent
  notification_failed
  error
  pending_payment
  payment_link_created
  payment_paid
  payment_failed
  payment_expired
  payment_retry_link_created
  payment_canceled
}

enum OrderPickupMode {
  asap
  scheduled
}
